{
    "article": "We study the problem of coarse-grained response selection in retrieval-based dialogue systems. The problem is equally important with fine-grained response selection, but is less explored in existing literature. In this paper, we propose a Contextual Fine-to-Coarse (CFC) distilled model for coarse-grained response selection in open-domain conversations. In our CFC model, dense representations of query, candidate contexts and responses is learned based on the multi-tower architecture using contextual matching, and richer knowledge learned from the one-tower architecture (fine-grained) is distilled into the multi-tower architecture (coarse-grained) to enhance the performance of the retriever. To evaluate the performance of the proposed model, we construct two new datasets based on the Reddit comments dump and Twitter corpus. Extensive experimental results on the two datasets show that the proposed method achieves huge improvement over all evaluation metrics compared with traditional baseline methods. Introduction Given utterances of a query, the retrieval-based dialogue (RBD) system aims to search for the most relevant response from a set of historical records of conversations (Higashinaka et al., 2014; Yan et al., 2016; Boussaha et al., 2019) . A complete RBD system usually contain two stages: coarse-grained response selection (RS) and fine-grained response selection (Fu et al., 2020) . As shown in Figure 1 , in coarse-grained RS stage, the retriever identifies a much smaller list of candidates (usually dozens) from large-scale candidate database (up to millions or more), then the ranker in fine-grained RS stage selects the best response from the retrieved candidate list. * Worked during the internship at Microsoft Research Asia. Zhongyu Wei and Yeyun Gong are corresponding authors. Recent studies (Whang et al., 2020; Xu et al., 2020 Xu et al., , 2021;; Whang et al., 2021) pay more attention on fine-grained RS and various complex models are proposed to compute the similarities between the query and candidates for response selection. Although promising improvements have been reported, the performance of fine-grained stage is inevitably limited by the quality of the candidate list constructed. Therefore, a high-quality coarsegrained RS module is crucial, which is less explored in existing literature (Lan et al., 2020) . In this paper, we focus on the task of coarsegrained response selection, i.e., dialogue response retrieval. There are two major challenges. First, different from general text matching tasks such as adhoc retrieval (Hui et al., 2018) or question answering (QA) retrieval (Karpukhin et al., 2020) , keywords overlapping between context and response in dialogue are potentially rare, such as when a topic transition (Sevegnani et al., 2021) occurs in response. This makes it difficult to directly match the query with candidate responses. Second, compared with fine-grained RS, coarse-grained RS deals with much larger number of candidates. Therefore, it is impractical to apply complex matching model that jointly process query and response for the similarity computation like in fine-grained RS, due to the retrieval latency (traverse millions of candidates on-line). Instead, the efficient BM25 system (Robertson and Zaragoza, 2009) based on sparse representations is the mainstream algorithm in coarsegrained text matching. To mitigate the above mentioned two problems, we propose a Contextual Fine-to-Coarse (CFC) distilled model for coarse-grained RS. Instead of matching query with response directly, we propose a novel task of query-to-context matching in coarsegrained retrieval, i.e. contextual matching. Given a query, it is matched with candidate contexts to find most similar ones, and the corresponding responses are returned as the retrieved result. In this case, the potential richer keywords in the contexts can be utilized. To take the advantage of complex model and keep the computation cost acceptable, we distillate the knowledge learned from fine-grained RS into coarse-grained RS while maintaining the original architecture. For the evaluation, there is no existing dataset that can be used to evaluate our model in the setting of contextual matching, because it needs to match context with context during training, while positive pairs of context-context is not naturally available like context-response pairs. Therefore, we construct two datasets based on Reddit comment dump and Twitter corpus. Extensive experimental results show that our proposed model greatly improve the retrieval recall rate and the perplexity and relevance of the retrieved responses on both datasets. The main contributions of this paper are threefold: 1) We explore the problem of coarse-grained RS in open domain conversations and propose a Contextual Fine-to-Coarse (CFC) distilled model; 2) We construct two new datasets based on Reddit comment dump and Twitter corpus, as a new benchmark to evaluate coarse-grained RS task; 3) We construct extensive experiments to demonstrate the effectiveness and potential of our proposed model in coarse-grained RS. Related Work Fine-grained Response Selection In recent years, many works have been proposed to improve the performance of fine-grained selection module in retrieval-based chatbots (Zhang et al., 2018; Zhou et al., 2018; Tao et al., 2019; Whang et al., 2019; Yuan et al., 2019) . Owing to the rapid development of pre-trained language models (PLMs) (Radford et al., 2019) , recent works (Gu et al., 2020; Whang et al., 2021; Sevegnani et al., 2021) achieve the state-of-the-art (SOTA) results by utilizing PLMs such as BERT (Devlin et al., 2018) to model cross-attention and complex intersection between the context and response. Coarse-grained Response Selection On the other hand, coarse-grained dialogue retrieval is an important but rarely explored field. Limited by efficiency, there are usually two methods for coarsegrained response selection, i.e., the sparse representations based method represented by BM25 (Robertson and Zaragoza, 2009) , and the dense representations based method represented by dual-Encoder (Chidambaram et al., 2018; Humeau et al., 2019; Karpukhin et al., 2020; Lan et al., 2020; Lin et al., 2020) . Method In coarse-grained response selection, there is a fixed candidate database containing a large number of context-response pairs. Formally, given a query, i.e., a new context, the goal is to retrieve Top-K most suitable responses for the query from the candidate database. We propose a contextual fine-to-coarse distillation framework for the task of coarse-grained RS. First, we formulate the problem as a task of contextual matching, i.e., match query with context instead response; Second, we utilize a multi-tower architecture to deal with the similarity computation of query and candidates in contextual matching; Third, we utilize knowledge distillation to leverage the deep interaction between query and response learned in one-tower architecture. Contextual Matching An intuitive idea of coarse-grained RS is to treat all responses as candidate documents and directly use query to retrieve them, while this non-contextual approach results in a quite low retrieval recall rate (Lan et al., 2020) . Inspired by recent studies of context-to-context matching in fine-grained RS (Fu et al., 2020) , we propose contextual matching in coarse-grained RS, which is to match the query with candidate contexts, and return the responses corresponding to the most similar contexts. We consider three ways of contextual matching. Query-Context (QC) In QC matching, we treat contexts instead of responses as candidate documents. At run-time, we calculate the similarities between query and candidate contexts, and the re-  sponses corresponding to the Top-K most similar contexts are returned as the retrieved results. The motivation of using QC matching is similar contexts may also share similar responses. Query-Session (QS) A session represents the concatenated text of context and corresponding response (Fu et al., 2020) , which we think is more informative than context alone. In QS matching, we treat sessions as candidate documents and return the responses in Top-K most similar sessions as the retrieved results. Decoupled Query-Session (DQS) Apart from QS matching, we also consider a decoupled way to match query with candidate sessions. In DQS matching, we treat contexts and responses as independent candidate documents. Similarities between query and contexts, query and responses are first calculated independently, then the query-session similarity can be obtained by the weighted sum. QS and DQS matching are actually two different ways to calculate query-session similarity. Multi-Tower Architecture For the retriever to search large-scale candidates with low latency, neural-based retrievers are usually designed as (or limited to) multi-tower architecture (Figure 2 ). In multi-tower models, the query and the candidates are independently mapped to a common vector space by different encoders, where similarity can be calculated. After training, the embeddings of large-scale candidates can be pre-calculated offline, and only the embedding of query needs to be calculated online. In this way, fast sublinear-time approximation methods such as approximate nearest neighbor search (Shrivastava and Li, 2014 ) can be utilized to search for Top-K vectors that are most similar to the query, which can achieve an acceptable retrieval latency during inference. Two-Tower Model For QC and QS matching, two-tower architecture is adopted. Taking QS matching as an example (Figure 2(a) ), the dense session encoder E S (\u2022) maps any candidate session to real-valued embedding vectors in a d-dimensional space, and an index is built for all the N session vectors for retrieval. At run-time, a different dense query encoder E Q (\u2022) maps the query to a d-dimensional vector, and retrieves k candidate sessions of which vectors are the closest to the query vector. We use the dot product of vectors as the similarity between query and candidate session following (Karpukhin et al., 2020) . Three-Tower Model For DQS matching, dense representations of query, context and response are independently calculated, the architecture is thus designed as three-tower with three encoders, which is query encoder E Q (\u2022), context encoder E C (\u2022) and response encoder E R (\u2022) (Figure 2(b)). Similarly, context and response vectors are calculated and cached offline respectively and two indexes are built for retrieving them. The final similarity of query and session is weighted by the dot product of query-context and queryresponse. The weighting coefficient \u03bb can be adjusted to determine whether it is biased to match the context or match the response 1 . Training Multi-Tower Model We unify the training of the two-tower and threetower models by formalizing them into a same met-ric learning problem (Kulis et al., 2012) . The goal is to learn a matching space where similarities between positive pairs is higher than negative ones, by learning a better embedding function. We use the training of three-tower model (DQS matching) as an example. Formally, we denote the training set as D = {q i , {k + i , k \u2212 i }} N i=1 . Each training instance contains a query q i , a set of positive examples k + i and a set of negative examples k \u2212 i . Among them, k + i contain several positive contexts and several positive responses, similarly, k \u2212 i contain several negative contexts and several negative responses. We optimize the loss function as the sum of negative log likelihood of all positive pairs simultaneously: L(q i ) = \u2212log k \u2032 \u2208{k + i } e sim(q i ,k \u2032 ) k \u2032 \u2208{k + i ,k \u2212 i } e sim(q i ,k \u2032 ) (1) where the similarity function is defined as: sim(q i , k \u2032 ) = E Q (q i ) \u2022 E(k \u2032 ). (2) The embedding function E(\u2022) of k \u2032 in Equation 2 can be E C (\u2022) or E R (\u2022), depending on the type of k \u2032 . Positive and negative examples The core issue of training multi-tower models for contextual matching is to find positive pairs of query-context (or query-session). In this paper, we assume that contexts with exactly the same response are positive samples of each other, which is a cautious but reliable strategy. Formally, given a response r, if there are multiple contexts whose response is r, then we can randomly selected one context as the query q, and the other contexts are positive contexts of q, and r is the positive response of q. Negative samples of contexts and responses can be obtained from in-batch (Karpukhin et al., 2020) or random sampling from database. Similarly, positive query-session is obtained by replacing the context in positive query-context with the whole session. Distillation from One-Tower Model In multi-tower architecture, the query and candidates are expressed by their embeddings independently, which may cause the loss of information, and their monotonous way of interaction (inner product) further limits the capability (Lin et al., 2020) . Comparing with multi-tower model, onetower model takes both the query and the candidate as a concatenated input and allow the cross attention between query and candidate in self-attention layer. Despite fewer parameters, one-tower model have been shown to learn a more informative representations than multi-tower model, thus it is preferred in fine-grained RS (Yang and Seo, 2020) . To leverage the richer expressiveness learned by the one-tower model, knowledge from one-tower model is distilled into multi-tower model to enhance the retriever. Training One-Tower Model Before distillation, we need to train teacher models based on one-tower architecture. Let's take the training of teacher model for QS matching as an example. A single encoder is trained to distinguish whether the query and the session are relevant (positive), and the form is exactly same as the next sentence prediction (NSP) task in the BERT (Devlin et al., 2018) pre-training. Formally, given a training set D = {q i , s i , l i } N i=1 , where q i is the query, s i is the candidate session and l i \u2208 {0, 1} denotes whether q i and s i is a positive pair. To be specific, given a query q and candidate session s, the encoder obtains the joint representation of the concatenated text of q and s, and then computes the similarity score through a linear layer, the training objective is binary cross entropy loss. We summarize the main difference between one-tower and multi-tower as follows: one-tower model is more expressive, but less efficient and cannot handle large-scale candidates. The main reason is that feature-based method of calculating similarity scores rather than inner product limits the capability of offline caching. For new queries, the similarities with all candidates can only be calculated by traversal. The huge latency makes it impossible to use one-tower model in coarse-grained response retrieval. To leverage the expressiveness of onetower model, we propose fine-to-coarse distillation, which can learn the knowledge of one-tower model while keeping the multi-tower structure unchanged, thereby improving the performance of the retriever. Fine-to-Coarse Distillation Take the two-tower student model (denoted as S) for QS matching as an example, suppose we have trained the corresponding one-tower teacher model (denoted as T ). For a given query q, suppose there are a list of sessions {s + , s \u2212 1 , ..., s \u2212 n } and the cor-responding label y = {1, 0, ..., 0} \u2208 R n+1 , that is, one positive session and n negative sessions. We denote the similarity score vector of querysessions computed by student model S (Equation 2 ) as z S \u2208 R n+1 , then the objective of Equation 1 is equivalent to maximizing the Kullback-Leibler (KL) divergence (Van Erven and Harremos, 2014) of the two distributions: softmax(z S ) and y, where softmax function turns the score vector to probability distribution. The one-hot label y treats each negative sample equally, while the similarity between query with each negative sample is actually different. To learn more accurate labels, we further use teacher model T to calculate the similarity score vector between q and S, denoted as z T \u2208 R n+1 . We then replace the original training objective with minimizing KL divergence of the two distributions softmax(z S ) and softmax(z T ) (Figure 1 ), where the temperature parameter is applied in softmax function to avoid saturation. The method of fine-to-coarse distillation is to push the student model (multi-tower) to learn the predicted label of teacher model (one-tower) as a soft target instead of original one-hot label. By fitting the label predicted by the teacher model, the multi-tower model can learn a more accurate similarity score distribution from the one-tower model while keeping the structure unchanged. Datasets Construction To evaluate the performance of the proposed model, we construct two new datasets based on the Reddit comments dump (Zhang et al., 2019) and Twitter corpus 2 . We create a training set, a multi-contexts (MC) test set and a candidate database for Reddit and Twitter respectively. For Reddit, we create an additional single-context (SC) test set. The motivation for these settings is explained in \u00a7 5.3. The size of our candidate database is one million in Twitter and ten million in Reddit respectively, which is very challenging for response retrieval. Table 1 shows the detailed statistics. We use exactly the same steps to build dataset for Reddit and Twitter, and similar datasets can also build from other large dialogue corpus in this way. MC test set We first find out a set of responses with multiple contexts from candidate database, denoted as R. For each response r in R, we randomly select one context c from its all corresponding contexts C r to construct a context-response (CR) pair, and put the others contexts (denoted as C \u2212 r ) back to the database. Our MC test set consists of these CR pairs. Each response in MC test set has multiple contexts, which ensures that there exits other contexts in the database that also correspond to this response, so the retrieval recall rate can be computed to evaluate the MC test set. SC test set We create another test set (SC) for Reddit dataset. Contrary to the MC test set, each response in SC test set has only one context, i.e., there is no context in the database that exactly corresponds to the response. Obviously, the retrieval recall rate is invalid (always zero) on SC test set. We introduce other methods to evaluate SC test set in \u00a7 5.2. The SC test set is a supplement to the MC test set which can evaluate the quality of retrieved responses given those \"unique\" contexts. Candidate database To adapt to different retrieval methods, the candidate database is designed with 4 fields, namely context, response, session. Our candidate database consists of random contextresponse pairs except those in the MC and SC test sets. Besides, as mentioned above, those unselected context-response pairs (C \u2212 r ) are deliberately merged into the database. Train set The construction of training set is intuitive and similar to test set. It consists of responses and their corresponding multiple contexts. Formally, the training set can be denote as D = {r i , c i,1 , ..., c i,q } N i=1 , r i is a response and {c i,1 , ..., c i,q } are all contexts with response r i , where q depends on r i , and q \u2265 2. It is worth noting that there is no overlap between the contexts in the database and the contexts in the training set, which may prevent potential data leakage during training process to overestimate the evaluation metrics. The details of dataset construction are introduced in Appendix A. Experiments We conduct extensive experiments on the constructed datasets. In this section, we present experimental settings, evaluation metrics, model performance, human evaluation, etc. to demonstrate the effectiveness of the proposed models. Compared Models For baselines, we select BM25 (Robertson and Zaragoza, 2009) as sparse representations based method, which is widely used in real scenarios in text matching. Based on BM25 system and the two matching methods (QC and QS matching), two retrievers can be obtained, denoted as BM25-QC and BM25-QS respectively. We choose multi-tower models as dense representations based methods. They are bi-encoder based two-tower models for QC matching and QS matching (denoted as BE-QC and BE-QS), and tri-encoder based three-tower model for DQS matching (denoted as TE-DQS). In addition, to demonstrate the advantages of contextual matching, we also report the results of queryresponse (QR) matching, two retrievers are build based on BM25 system and two-tower model (denoted as BM-QR and BE-QR). There are three variants of our proposed CFC models, they are the distilled versions of BE-QC, BE-QS and TE-DQS, which are called CFC-QC, CFC-QS and CFC-DQS respectively. The distillation of each student model needs to train the corresponding teacher model. In particular, the distillation from TE-DQS to CFC-DQS requires two teacher models, because the similarity between both query-context and query-response needs to be calculated. We summarize the details of compared models and provide training details in Appendix B. Evaluation Metrics Following previous work (Xiong et al., 2020; Karpukhin et al., 2020) , Coverage@K is used to evaluate whether Top-K retrieved candidates include the ground-truth response. It is equivalent to recall metric R M @K that often used in fine-grained RS, where N is the size of candidate database. However, Coverage@K is only suitable for evaluating the MC test set, and it is incapable for evaluating the overall retrieval quality due to the one-to-many relationship between context and response. As a supplement, we propose two automated evaluation metrics based on pre-trained mod-els, i.e., Perplexity@K and Relevance@K. For retrieved Top-K responses, DialogGPT (Zhang et al., 2019) is used to calculate the conditional perplexity of the retrieved response given the query. Dialog-GPT is a language model pre-trained on 147M multi-turn dialogue from Reddit discussion thread and thus very suitable for evaluating our created Reddit dataset. Perplexity@K is the average perplexity of Top-K retrieved responses. In addition to Perplexity, we also evaluate the correlation between the query and retrieved response. We use Dialo-gRPT (Gao et al., 2020) , which is pre-trained on large-scale human feedback data with the humanvs-rand task that predicts how likely the response is corresponding to the given context rather than a random response. Relevance@K is the average predicted correlation degree between query and Top-K retrieved responses. Perplexity@K and Relevance@K are average metrics based on all Top-K retrieved responses, so they can reflect the overall retrieval quality. Overall Performance We demonstrate the main results in Table 2 and Table 3 and discuss model performance from multiple perspectives. Dense vs. sparse It can be seen that the performance of dense retrievers far exceed that of the BM25 system, which shows rich semantic information of PLMs and additional training can boost the performance of the retriever. For example, compared with BM25 system, the best undistilled dense retrievers (BE-QS) have a obvious improvement in three metrics. For Coverage@K, the Top-500 recall rate of BE-QS on the MC test set of Reddit and Twitter increase by 12.1% and 17.4% absolute compared with BM25-QS. For Perplexity@K, the Top-20 average perplexity of BE-QS on the MC and SC test sets of Reddit is reduced by 8.1 and 8.5 absolute compared with BM25-QS. For Relevance@K, the Top-20 average relevance of BE-QS on the MC and SC test sets on Reddit increase by 6.3% and 6.5% absolute compared with BM25-QS. Coverage@K measures the retriever's ability to retrieve gold response, while Perplexity@K and Relevance@K measure the overall retrieval quality. Our results show the consistency of the three metrics, namely, the recall rate and the overall retrieval quality have a positive correlation. Matching method Compared with contextual matching, query-response (QR) matching has a MC Test Set SC Test Set Retriever Coverage@K Perplexity@K Relevance@K Perplexity@K Relevance@K Top-1 Top-20 Top-100 Top-500 Top-1 Top-20 Top-1 Top-20 Top-1 Top-20 Top-1 Top- Table 2 : Automated evaluation metrics on Reddit test set. For MC and SC test set, we both report Perplexity@1/20 and Relevance@1/20; for SC test set, we additionally report Coverage@1/20/100/500. For Coverage@K and Relevance@K, we report the numerator of its percentage, and the larger the better; for Perplexity@K, the smaller the better. Retriever Coverage@K Top-1 Top-20 Top-100 Top-500 much lower retrieval recall rate, which is also verified in (Lan et al., 2020) . We think it is because that response is usually a short text of one-sentence and contains insufficient information, and there may be little keywords that overlap with the query. Therefore, it is important to consider contextual matching in the RBD system. Compared to QC matching, QS and DQS matching should be encouraged in practice due to the additional information provided by the response. However, the BM25 system can not make good use of the information of response, as BM25-QS model does not show obvious advantages over BM25-QC on both Reddit and Twitter datasets. In contrast, dense retrieval models can effectively utilize the response. For example, BE-QS outperforms BE-QC greatly by 7.9% absolute in terms of Top-500 response retrieval recall rate in MC test set of Reddit. For QS and DQS matching, there is little difference in performance. Especially for SC test set on Reddit and MC test set on Twitter, the performance difference is minimal. One potential advantage of DQS is that it can utilize positive query-response pairs, whose number is much larger than positive query-context pairs. Distillation benefit We further focus on the performance gain from fine-to-coarse distillation. The distilled models achieve obvious improvement in all three metrics. An obvious pattern is that the distilled models get more larger improvement with a smaller K. Take Twitter dataset as example, the Top-500 retrieval recall rate of CFC models increase by 1.5\u223c2.4 after distillation, while the Top-1 retrieval recall rate increased by 4.6\u223c6.7. On Perplexity@K and Relevance@K, our CFC models has similar performance. The significant improvement in the retrieval recall rate at small K's is especially beneficial to fine-grained response selection, because it opens up more possibility to the ranker to choose good response while seeing fewer candidates. The above results indicate that our student models benefit from learning or inheriting fine-grained knowledge from teacher models. To more clearly demonstrate the performance gains of our model after distillation, we provide the specific values of these gains in Table 8 in Appendix C. Difference between Reddit and Twitter Since DialogGPT and DialogRPT is not pre-trained on Twitter, Perplexity@K and Relevance@K are not  suitable for evaluating Twitter dataset. Therefore, we do not build SC test set for Twitter. Compared to Twitter, the Reddit dataset we use is much larger with more common multi-turn conversations, and significantly higher retrieval difficulty. The Top-500 retrieval recall rate on Twitter reach 60%, while Reddit only reached about 20%, which indicates that the coarse-grained response retrieval task in open domain conversations still has great 6 Further Analysis Parameter Sharing Sharing parameters in dual-encoder structure is a common practice. As shown in Figure 2 , for the encoders in the dotted line, sharing parameters may be beneficial. We try parameter sharing settings on the BE-QC and TE-DQS models, respectively. We add two sets of experiments on the MC test set of Reddit, as shown in Table 4 . The results show that whether or not to share parameters has little impact on Coverage@K. Therefore, we can share encoder parameters to reduce model complexity with little loss of performance. Our guess is as follows, the sampling strategy (with replacement) create a certain probability that the query and the context are exactly the same, so the multi-tower model can learn that two identical samples are positive samples for each other, even if the parameters of the encoders are not shared. Effect of Database Size We discuss the impact of the size of candidate database on the performance of the model. For different candidate database size (from one million to ten million), we compare the Coverage@500 metric of BM25-QS, BE-QS, and CFC-QS on the MC test set of Reddit (Figure 3 ). It can be seen that Coverage@500 shows a slow downward trend as the database size increases. Increasing the size of the database will not make the model performance drop rapidly, which shows the effectiveness and robustness of our models. Human Evaluation To further evaluate and compare our models, we conduct a human evaluation experiment. We random select 1000 queries from the MC and SC test set (500 each) of Reddit dataset, and retrieve the Top-1 response by the BM25-QS, BE-QS and CFC-QS models respectively. Three crowd-sourcing workers are asked to score the responses. For each query, the annotator will strictly rank the retrieved responses of the three models. We report the average rank scores (between 1 and 3, the smaller the better) and the winning rate in pairwise comparison. Each two annotators have a certain number (about 200) of overlapping annotated samples. To evaluate the inter-rater reliability, the Cohen's kappa coefficient (Kraemer, 2014) is adopted. Table 5 and Table 6 report the average ranking score of each model and pairwise comparison between models respectively. The average ranking score of CFC-QS is the highest, and CFC-QS can beat BE-QS and BM25 in most cases (74.7%\u223c81.6%), which indicates CFC-QS occupies a clear advantage in Top-1 retrieval. All Co-hen's Kappa coefficients is between 0.6 and 0.7, indicating annotators reach moderate agreement. The results of human evaluation further verify the performance improvement brought by distillation to the model. We select several examples with human evaluation as case study and these results are presented in Appendix D. Retrieval efficiency We compare the retrieval latency of BM25-QS and BE-QS on the reddit MC test set, which represent the efficiency of the sparse and dense retriever respectively. We fix the batch size to 32 and retrieve top 100 most similar candidates. With the help of FAISS index, the average retrieval time of each batch by BE-QS is 581.8ms. In contrast, the average retrieval time by BM25 system using file index is 1882.6ms, about three times that of BE-QS. This indicates that the dense retriever also has an advantage in retrieval efficiency. The relatively inferior of dense retriever is that it needs to compute the embeddings of the candidate database and establish the FAISS index, which is quite time-consuming and it takes about 9 hours for BE-QS to handle 10 million candidates with 8 GPUs, while it only takes about 10 minutes to build a BM25 index. Since distillation does not change the structure of the retriever, it will not affect the retrieval efficiency. The cost of distillation is mainly reflected in the training of the teacher model and the extensive forward calculation in the distillation process. Conclusion In this paper, we propose a Contextual Fine-to-Coarse (CFC) distilled model. In CFC model, we adopt matching on both query-response and querycontext. Considering the retrieval latency, we use multi-tower architecture to learn the dense representations of queries, responses and corresponding contexts. To further enhance the performance of the retriever, we distill the knowledge learned by the one-tower architecture (fine-grained) into the multi-tower architecture (coarse-grained). We construct two new datasets based on Reddit comment dump and Twitter corpus, and extensive experimental results demonstrate the effectiveness and potential of our proposed model. In the future work, we will further explore how the enhancement of coarse-grained RS can help fine-grained RS. 21QA1400600, GWV-1.1, 21511101000) and Zhejiang Lab (No. 2019KD0AD01). Ethical Statement In this paper, different ethical restrictions deserve discussion. The datasets we created are derived from large dialogue corpus that publicly available on the Internet, and we strictly followed the platform's policies and rules when obtaining data from web platforms. We did not use any author-specific information in our research. Online large dialogue corpus may includes some bias, such as political bias and social bias, and our model might have inherited some forms of these bias. In order to limit these bias as much as possible, we filter controversial articles and removed data with offensive information when possible. A Dataset Construction Details To filter boring and dull content and speed up the retrieval speed, we set a limit for the length of contexts and responses. We limit the context to contain at least 5 words and less than 128 words, and the response contains at least 5 words and less than 64 words. It is specially beneficial to limit the length of the response, since according to our statistics, many short responses such as \"Fair Enough\" and \"Thanks :D\" may have large number (tens of thousands) of different contexts. Besides, we also limit the upper limit of the number of contexts corresponding to the response. The number of contexts of each response in the MC test set is limited to no more than 50, which is to prevent the selected responses from being a meaningless universal response. The detailed construction of the two test sets is described in Algorithm 1. To construct the training set, we need to find out responses that corresponding multiple contexts. \u25b7 Find all contexts whose response is r. 6: if |C r | > 1 then 7: C \u2212 r , c = Split(C r ) \u25b7 Random pick one context c from C r , the remaining contexts is denoted as C \u2212 r . 8: M C \u2032 = M C \u2032 \u222a {c, r} 9: else 10: SC \u2032 = SC \u2032 \u222a {c \u2208 C r , r} 11: end if 12: end for each 13: M C = RandomSample(M C \u2032 ) 14: SC = RandomSample(SC \u2032 ) 15: return SC, M C We use dict to implement it, where the key is the response and the value is the list of corresponding contexts. During the training of the multi-tower model, in each iteration, a batch of keys is randomly sampled from the dict. For each key (i.e., each response) in the batch, two contexts are randomly selected from the corresponding value (i.e., the list of contexts), one of which is used as the query and the other is used as a positive context, and the key is used as a positive response. The other contexts and responses in the batch are all negative instances of the query. B Model Details Due to the different matching methods, the training of different retrievers requires slightly different input. Taking BE-QC as an example, given a query, positive and negative contexts are needed to learn the representation of query and contexts, while in BE-QS, positive and negative sessions are required. Besides, the distillation of each student model requires training corresponding teacher model, and the data of training teacher model is consistent with the student model. We summarize the input, output, and training objectives of student and teacher models in Table 7 . To implement the BM25 method, we use Elasticsearch 3 , which is a powerful search engine based on Lucene library (Bia\u0142ecki et al., 2012) . For dense  retrieval methods, FAISS (Johnson et al., 2019) toolkit is used to retrieve candidate vectors. All encoders in our tower models (including one-tower, two-tower and three-tower) are initialized with bertbase 4 , which includes 12 encoder layers, embedding size of 768 and 12 attention heads. For dense models (BE-QC, BE-QS, TE-DQS), we use the same batch size of 32 for Reddit and Twitter, and we train 30 epochs on Reddit and 10 epochs on Twitter. For all teacher models, we use the same batch size of 16, and we train 40 epochs on Reddit and 20 epochs on Twitter. For the distillation (CFC-QC, CFC-QS, CFC-DQS), we train additional 10 epochs on reddit and 5 epochs on twitter respectively, starting from the early checkpoints (20 epochs in Reddit and 5 epochs in Twitter for fair comparison) of BE-QC, BE-QS, TE-DQS. We use Adam (Kingma and Ba, 2014) optimizer with learning rate of 2e-4 and the warmup steps of 200 to optimize the parameters. We set the knowledge distillation temperature to 3 and the rate of distillation loss to 1.0. All experiments are performed on a server with 4 NVIDIA Tesla V100 32G GPUs. C Distillation Benefit To more clearly show the performance gains of our model after distillation, we present the specific values of these gains in Table 8 . Readers can compare the results in this table when reading the Distillation Benefit part in \u00a7 5.3. Positive Coverage@K and Relevance@K, and negative Perplexity@K all represent the improvement of model performance. After the distillation, the accuracy and correlation between the retrieved responses and the query increase, and the conditional perplexity decreases, indicating the huge benefits of distillation. D Case Study As sparse representations base method, BM25 system tends to retrieve responses that overlaps with the context. For some complicated cases, BM25 cannot correctly retrieve those seemingly unrelated, but are the best answer in the current context. In second case of Table 9 , BM25 selects the response that contains \"Spider Man 2099\" in the query. But in the context of the forum, \"Can I get Spider Man 2099\" is actually looking for the e-book files of this comic. Compared to the comments of Spider Man 2099 given by BM25, our 4 https://huggingface.co/ bert-base-uncased model retrieves \"You got it PM (private message) sent!\" is a harder to find, but more accurate response. The third case is an in-game item trading query. In related forums, \"keys\" are used as currency. \"Knife Scorched FT\" and \"19keys\" in query respectively represent an item to be sold and its expected price. The result of BM25 covers \"knife\" and \"key\", but the meaning of the whole sentence does not match the query. On the other hand, our model selected \"I only have 15keys\", a standard bargaining, perfectly match the query. There are also some examples such as case 4. Our model gives worse results than BM25. In case 4, CFC-QS retrieves a worse result, and the response retrieved by BE-QS is relatively better. Acknowledgments Table 9 : Four retrieved cases on our human evaluation set. We report Top-1 retrieved response of the three models as well as gold response. The Rank column is the ranking of the three responses given by the annotator (the lower the better).",
    "abstract": "We study the problem of coarse-grained response selection in retrieval-based dialogue systems. The problem is equally important with fine-grained response selection, but is less explored in existing literature. In this paper, we propose a Contextual Fine-to-Coarse (CFC) distilled model for coarse-grained response selection in open-domain conversations. In our CFC model, dense representations of query, candidate contexts and responses is learned based on the multi-tower architecture using contextual matching, and richer knowledge learned from the one-tower architecture (fine-grained) is distilled into the multi-tower architecture (coarse-grained) to enhance the performance of the retriever. To evaluate the performance of the proposed model, we construct two new datasets based on the Reddit comments dump and Twitter corpus. Extensive experimental results on the two datasets show that the proposed method achieves huge improvement over all evaluation metrics compared with traditional baseline methods.",
    "countries": [
        "China"
    ],
    "languages": [
        ""
    ],
    "numcitedby": "2",
    "year": "2022",
    "month": "May",
    "title": "Contextual Fine-to-Coarse Distillation for Coarse-grained Response Selection in Open-Domain Conversations"
}